---
globs: orti-finance-api/ai_analysis_service.py, orti-finance-api/main.py, orti-finance-compass/src/components/AIAnalysisPanel.tsx
alwaysApply: true
---

# Integrazione AI con Sequential Thinking

## Servizio AI Principale:
- **Sequential Thinking MCP Server**: Fornisce ragionamento strutturato passo-passo per analisi finanziarie, configurato in `mcp.json`.
- **ai_analysis_service.py**: Logica business per analisi AI, usa tool `sequential_thinking` per variance e budget.
- **SequentialThinkingService**: Classe principale con metodi async come `analyze_variance` (indagine scostamenti) e `analyze_budget_planning` (pianificazione budget).

## Endpoint AI:
- `POST /api/companies/{company_name}/ai-analysis`: Esegui analisi sequenziale.
  - Parametri: `analysis_type` (es. "variance_investigation"), `year`, `month` (opzionale), `variance_threshold` (default 0.15).
  - Output: Struttura con `analysis_steps` (passi ragionamento), `executive_summary` (raccomandazioni, impatto finanziario).
- `GET /api/companies/{company_name}/ai-analysis/types`: Lista tipi analisi disponibili (es. variance_investigation, budget_planning).
- `GET /api/companies/{company_name}/ai-analysis/quick-insights/{year}`: Insights rapidi per dashboard.

## Integrazione Frontend:
- **AIAnalysisPanel.tsx**: Componente React per interfaccia AI con 3 tabs: Quick Insights, Deep Analysis, Results.
- **Integrazione**: Pulsante con icona Brain in `ZenFinancialDashboard.tsx`. Usa hook `useFinanceAPI` per chiamate AI.
- **Gestione Stato**: Real-time updates via subscriptions Supabase post-analisi.

## Processo Sequential Thinking:
1. **Break Down**: Problemi complessi in passi gestibili.
2. **Revise**: Raffina pensieri man mano.
3. **Branch**: Percorsi alternativi di ragionamento.
4. **Verify**: Genera e testa ipotesi.
5. **Conclude**: Raccomandazioni actionable con score di confidenza.

## Tipi Analisi:
- **Variance Investigation**: Analisi root cause di scostamenti budget vs actual, con ipotesi e raccomandazioni.
- **Budget Planning**: Pianificazione finanziaria strategica con aggiustamenti stagionali e rischi.
- **Seasonal Optimization**: Ottimizzazione revenue per stagioni peak/low.
- **Cash Flow Analysis**: Previsione liquidit√† e gestione capitale.