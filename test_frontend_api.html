<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß™ Frontend API Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        .loading { background: #fff3cd; border-color: #ffeaa7; }
        button { padding: 10px 20px; margin: 5px; border: none; background: #007bff; color: white; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Frontend-Backend API Test</h1>
        
        <div class="test-section" id="healthTest">
            <h3>üîç Backend Health Check</h3>
            <button onclick="testHealth()">Test Health</button>
            <div id="healthResult"></div>
        </div>

        <div class="test-section" id="entriesTest">
            <h3>üìä Get Entries</h3>
            <button onclick="testGetEntries()">Get Entries</button>
            <div id="entriesResult"></div>
        </div>

        <div class="test-section" id="summaryTest">
            <h3>üè¢ Company Summary</h3>
            <button onclick="testCompanySummary()">Get Company Summary</button>
            <div id="summaryResult"></div>
        </div>

        <div class="test-section" id="updateTest">
            <h3>üîÑ Update Entry</h3>
            <button onclick="testUpdateEntry()">Test Update</button>
            <div id="updateResult"></div>
        </div>

        <div class="test-section" id="consoleTest">
            <h3>üñ•Ô∏è Console Log</h3>
            <div id="consoleResult"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000';
        
        // Utility function to log to both console and UI
        function logToUI(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.createElement('div');
            logDiv.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            
            if (type === 'error') {
                logDiv.style.color = 'red';
            } else if (type === 'success') {
                logDiv.style.color = 'green';
            }
            
            element.appendChild(logDiv);
            console.log(`[${timestamp}] ${message}`);
        }

        // Test 1: Health Check
        async function testHealth() {
            const result = document.getElementById('healthResult');
            result.innerHTML = '‚è≥ Testing...';
            
            try {
                const response = await fetch(`${API_BASE}/`);
                const data = await response.json();
                
                result.innerHTML = `
                    <div class="success">
                        ‚úÖ <strong>Success!</strong><br>
                        Message: ${data.message}<br>
                        Version: ${data.version}
                    </div>
                `;
                logToUI('consoleResult', 'Health check passed', 'success');
            } catch (error) {
                result.innerHTML = `
                    <div class="error">
                        ‚ùå <strong>Error:</strong> ${error.message}
                    </div>
                `;
                logToUI('consoleResult', 'Health check failed: ' + error.message, 'error');
            }
        }

        // Test 2: Get Entries
        async function testGetEntries() {
            const result = document.getElementById('entriesResult');
            result.innerHTML = '‚è≥ Loading entries...';
            
            try {
                const response = await fetch(`${API_BASE}/entries?year=2024&limit=3`);
                const data = await response.json();
                
                result.innerHTML = `
                    <div class="success">
                        ‚úÖ <strong>Entries loaded!</strong><br>
                        Count: ${data.count}<br>
                        Success: ${data.success}
                        <pre>${JSON.stringify(data.data?.[0], null, 2)}</pre>
                    </div>
                `;
                logToUI('consoleResult', `Loaded ${data.count} entries`, 'success');
            } catch (error) {
                result.innerHTML = `
                    <div class="error">
                        ‚ùå <strong>Error:</strong> ${error.message}
                    </div>
                `;
                logToUI('consoleResult', 'Get entries failed: ' + error.message, 'error');
            }
        }

        // Test 3: Company Summary
        async function testCompanySummary() {
            const result = document.getElementById('summaryResult');
            result.innerHTML = '‚è≥ Loading company summary...';
            
            try {
                const response = await fetch(`${API_BASE}/companies/ORTI/summary/2025?include_projections=true`);
                const data = await response.json();
                
                result.innerHTML = `
                    <div class="success">
                        ‚úÖ <strong>Company Summary loaded!</strong><br>
                        Success: ${data.success}<br>
                        Year: ${data.summary?.year}<br>
                        Categories: ${Object.keys(data.summary?.consolidated?.categories || {}).length}
                        <pre>${JSON.stringify({
                            consolidated_revenue: data.summary?.consolidated?.total_revenue,
                            projection_revenue: data.summary?.projections?.total_revenue
                        }, null, 2)}</pre>
                    </div>
                `;
                logToUI('consoleResult', 'Company summary loaded successfully', 'success');
            } catch (error) {
                result.innerHTML = `
                    <div class="error">
                        ‚ùå <strong>Error:</strong> ${error.message}
                    </div>
                `;
                logToUI('consoleResult', 'Company summary failed: ' + error.message, 'error');
            }
        }

        // Test 4: Update Entry
        async function testUpdateEntry() {
            const result = document.getElementById('updateResult');
            result.innerHTML = '‚è≥ Testing entry update...';
            
            try {
                // First get an entry to update
                const entriesResponse = await fetch(`${API_BASE}/entries?year=2024&limit=1`);
                const entriesData = await entriesResponse.json();
                
                if (!entriesData.data || entriesData.data.length === 0) {
                    throw new Error('No entries found to update');
                }
                
                const entryId = entriesData.data[0].id;
                const updateData = {
                    value: 12345.67,
                    notes: 'Frontend API Test Update'
                };
                
                const updateResponse = await fetch(`${API_BASE}/entries/${entryId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updateData)
                });
                
                const updateResult = await updateResponse.json();
                
                result.innerHTML = `
                    <div class="success">
                        ‚úÖ <strong>Entry updated!</strong><br>
                        Success: ${updateResult.success}<br>
                        Message: ${updateResult.message}<br>
                        New Value: ${updateResult.data?.value}
                    </div>
                `;
                logToUI('consoleResult', 'Entry update successful', 'success');
            } catch (error) {
                result.innerHTML = `
                    <div class="error">
                        ‚ùå <strong>Error:</strong> ${error.message}
                    </div>
                `;
                logToUI('consoleResult', 'Entry update failed: ' + error.message, 'error');
            }
        }

        // Auto-run health check on load
        window.onload = function() {
            logToUI('consoleResult', 'Frontend API Test loaded', 'success');
            testHealth();
        };
    </script>
</body>
</html>